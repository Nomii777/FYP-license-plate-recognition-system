{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <h2 class="mb-4">Processing Results</h2>
        
        {% if original_image %}
        <!-- Image Processing Results -->
        <div class="card mb-4">
            <div class="card-header">
                Original Image
            </div>
            <div class="card-body text-center">
                <img src="{{ url_for('static', filename='uploads/' + original_image) }}" class="img-fluid rounded" alt="Original Image">
                <div class="mt-3">
                    <a href="{{ url_for('static', filename='uploads/' + original_image) }}" download class="btn btn-outline-primary">
                        <i class="bi bi-download"></i> Download Original Image
                    </a>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                Detected License Plate
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 text-center">
                        <img src="{{ url_for('static', filename='uploads/' + plate_image) }}" class="img-fluid rounded mb-3" alt="Detected License Plate">
                        <div class="mt-3">
                            <a href="{{ url_for('static', filename='uploads/' + plate_image) }}" download class="btn btn-outline-primary">
                                <i class="bi bi-download"></i> Download Plate Image
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4>Recognized Text:</h4>
                        <div class="display-4 text-primary">{{ plate_info.text }}</div>
                        <div class="mt-3 d-flex gap-2">
                            <button class="btn btn-outline-secondary" onclick="copyToClipboard('{{ plate_text }}')">
                                <i class="bi bi-clipboard"></i> Copy Text
                            </button>
                            <button class="btn btn-outline-success" onclick="downloadText('{{ plate_text }}', 'plate_text.txt')">
                                <i class="bi bi-download"></i> Download Text
                            </button>
                        </div>
                        
                        {% if plate_info.registration_info %}
                        <div class="alert alert-success mt-3">
                            <h5>Vehicle Registered</h5>
                            <ul class="list-unstyled">
                                <li><strong>Owner:</strong> {{ plate_info.registration_info.owner }}</li>
                                <li><strong>Model:</strong> {{ plate_info.registration_info.model }}</li>
                                <li><strong>Status:</strong> 
                                    <span class="badge bg-{% if plate_info.registration_info.status == 'Registered' %}success{% elif plate_info.registration_info.status == 'Stolen' %}danger{% else %}warning{% endif %}">
                                        {{ plate_info.registration_info.status }}
                                    </span>
                                </li>
                            </ul>
                        </div>
                        {% else %}
                        <div class="alert alert-danger mt-3">
                            <h5>Vehicle Not Registered</h5>
                            <p>The license plate was not found in our database.</p>
                        </div>
                        {% endif %}
                        
                        <!-- <button class="btn btn-outline-secondary mt-3" onclick="copyToClipboard('{{ plate_info.text }}')">Copy Text</button> -->
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if original_video %}
        <!-- Video Processing Results -->
        <div class="card mb-4">
            <div class="card-header">
                Original Video
            </div>
            <div class="card-body text-center">
                <video controls class="img-fluid rounded">
                    <source src="{{ url_for('static', filename='uploads/' + original_video) }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        </div>
        
        {% if plate_results %}
        <div class="card mb-4">
            <div class="card-header">
                Detection Results
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Frame</th>
                                <th>License Plate</th>
                                <th>Recognized Text</th>
                                <th>Registration Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in plate_results %}
                            <tr>
                                <td><img src="{{ url_for('static', filename='uploads/' + result.frame) }}" class="img-thumbnail" style="max-height: 50px;"></td>
                                <td><img src="{{ url_for('static', filename='uploads/' + result.plate_image) }}" class="img-thumbnail" style="max-height: 50px;"></td>
                                <td>{{ result.plate_text }}</td>
                                <td>
                                    {% if result.registration_info %}
                                    <span class="badge bg-success">Registered</span>
                                    {% else %}
                                    <span class="badge bg-danger">Not Found</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-warning">
            No license plates were detected in the video.
        </div>
        {% endif %}
        {% endif %}
        
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a href="{{ url_for('index') }}" class="btn btn-primary">Back to Home</a>
        </div>
    </div>
</div>
<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        alert('Text copied to clipboard: ' + text);
    }, function(err) {
        console.error('Could not copy text: ', err);
    });
}

function downloadText(text, filename) {
    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', filename);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}
</script>
{% endblock %}